name: manual-build-multiarch

on:
  workflow_dispatch:
    inputs:
      targets:
        description: |
          必填：构建目标目录（支持一个或多个，换行分隔）。
          规则：images/<lang>/<version>/Dockerfile
          示例（单个）：images/python/3.12
          示例（多个）：
          images/java/17
          images/node/20
        required: true
        default: "images/python/3.12"

      push:
        description: "是否推送到 DockerHub（true/false）。dry-run 用 false"
        required: true
        default: "true"

      platforms:
        description: |
          构建架构（逗号分隔）。
          默认：linux/amd64,linux/arm64/v8
          全量示例：
          linux/amd64,linux/arm64/v8,linux/386,linux/arm/v5,linux/arm/v7,linux/ppc64le,linux/riscv64,linux/s390x
        required: false
        default: "linux/amd64,linux/arm64/v8"

      tag_latest:
        description: "是否额外打 latest（true/false）"
        required: true
        default: "false"

      extra_tags:
        description: "可选：额外 tag（逗号分隔），例如 rc,20260203"
        required: false
        default: ""

concurrency:
  group: manual-docker-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  # 镜像命名：<dockerhub_namespace>/<repo>-<lang>
  DOCKERHUB_NAMESPACE: ${{ secrets.DOCKERHUB_USERNAME }}
  IMAGE_PREFIX: ${{ github.event.repository.name }}

jobs:
  plan:
    name: Plan build matrix from targets
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.gen.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - id: gen
        shell: bash
        run: |
          set -euo pipefail

          raw="${{ inputs.targets }}"
          raw="$(echo "$raw" | sed 's/\r//g')"

          items=()

          while IFS= read -r line; do
            t="$(echo "$line" | xargs)"   # trim
            [[ -z "$t" ]] && continue

            # 允许输入 images/lang/version 或 images/lang/version/Dockerfile
            if [[ "$t" == */Dockerfile ]]; then
              ctx="$(dirname "$t")"
              df="$t"
            else
              ctx="$t"
              df="$t/Dockerfile"
            fi

            if [[ ! -f "$df" ]]; then
              echo "ERROR: Dockerfile not found: $df"
              exit 1
            fi

            # 固定规则：images/<lang>/<version>
            lang="$(echo "$ctx" | awk -F/ '{print $2}')"
            ver="$(echo "$ctx"  | awk -F/ '{print $3}')"

            if [[ -z "$lang" || -z "$ver" ]]; then
              echo "ERROR: Unrecognized target path: $ctx (expected images/<lang>/<version>)"
              exit 1
            fi

            items+=("{\"lang\":\"$lang\",\"version\":\"$ver\",\"context\":\"$ctx\",\"dockerfile\":\"$df\"}")
          done <<< "$raw"

          if [[ ${#items[@]} -eq 0 ]]; then
            echo "ERROR: No valid targets provided."
            exit 1
          fi

          json="{\"include\":[ $(IFS=,; echo "${items[*]}") ]}"
          echo "matrix=$json" >> $GITHUB_OUTPUT

  build:
    name: Build & optional push
    needs: plan
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.plan.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      # 多架构必备：QEMU
      - uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      # ✅ 修复 warning：不再使用 install:true（docker buildx install 已废弃）
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          use: true

      # 仅在 push=true 时登录（dry-run 不登录）
      - name: Login to DockerHub
        if: ${{ inputs.push == 'true' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - id: meta
        shell: bash
        run: |
          set -euo pipefail

          SHORT_SHA="${GITHUB_SHA::7}"
          IMAGE="${{ env.DOCKERHUB_NAMESPACE }}/${{ env.IMAGE_PREFIX }}-${{ matrix.lang }}"

          tags=()
          # 永远生成：<version>、<version>-<shortsha>
          tags+=("${IMAGE}:${{ matrix.version }}")
          tags+=("${IMAGE}:${{ matrix.version }}-${SHORT_SHA}")

          # 可选 latest
          if [[ "${{ inputs.tag_latest }}" == "true" ]]; then
            tags+=("${IMAGE}:latest")
          fi

          # 可选 extra tags（逗号分隔）：以 <version>-<extra> 的形式追加
          extra="${{ inputs.extra_tags }}"
          extra="$(echo "$extra" | sed 's/\r//g' | tr -d ' ')"
          if [[ -n "$extra" ]]; then
            IFS=',' read -ra arr <<< "$extra"
            for x in "${arr[@]}"; do
              [[ -z "$x" ]] && continue
              tags+=("${IMAGE}:${{ matrix.version }}-$x")
            done
          fi

          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "tags=$(IFS=,; echo "${tags[*]}")" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Validate platforms input
        shell: bash
        run: |
          set -euo pipefail
          p="${{ inputs.platforms }}"
          p="$(echo "$p" | tr -d ' ')"
          if [[ -z "$p" ]]; then
            echo "ERROR: inputs.platforms is empty"
            exit 1
          fi
          if ! echo "$p" | grep -q "linux/"; then
            echo "ERROR: inputs.platforms must be comma-separated like linux/amd64,linux/arm64/v8"
            exit 1
          fi
          echo "Platforms: $p"

      # push=false：更快（不生成 provenance/SBOM）
      - name: Build (dry-run, no push)
        if: ${{ inputs.push != 'true' }}
        uses: docker/build-push-action@v6
        with:
          builder: ${{ steps.buildx.outputs.name }}
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: ${{ inputs.platforms }}
          push: false
          tags: ${{ steps.meta.outputs.tags }}

          # ✅ 小升级：dry-run 不生成 attestations，减少开销与噪音
          provenance: false

          cache-from: type=gha,scope=${{ matrix.lang }}-${{ matrix.version }}
          cache-to: type=gha,mode=max,scope=${{ matrix.lang }}-${{ matrix.version }}

          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.ref.name=${{ github.ref_name }}
            org.opencontainers.image.workflow=${{ github.workflow }}

      # push=true：发布级（生成 provenance + SBOM）
      - name: Build & push (release)
        if: ${{ inputs.push == 'true' }}
        uses: docker/build-push-action@v6
        with:
          builder: ${{ steps.buildx.outputs.name }}
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: ${{ inputs.platforms }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}

          # ✅ 小升级：发布时生成 provenance + SBOM（attestations）
          provenance: true
          sbom: true

          cache-from: type=gha,scope=${{ matrix.lang }}-${{ matrix.version }}
          cache-to: type=gha,mode=max,scope=${{ matrix.lang }}-${{ matrix.version }}

          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.ref.name=${{ github.ref_name }}
            org.opencontainers.image.workflow=${{ github.workflow }}

      - name: Summary
        shell: bash
        run: |
          echo "Targets   : ${{ matrix.context }}"
          echo "Platforms : ${{ inputs.platforms }}"
          echo "Image     : ${{ steps.meta.outputs.image }}"
          echo "Tags      : ${{ steps.meta.outputs.tags }}"
          echo "Push      : ${{ inputs.push }}"
          if [[ "${{ inputs.push }}" == "true" ]]; then
            echo "Attest    : provenance=true, sbom=true"
          else
            echo "Attest    : provenance=false (dry-run)"
          fi
